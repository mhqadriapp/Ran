<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ran Image Generator</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6a11cb">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            --secondary-color: #ff6b6b;
            --bg-color: #f0f2f5;
            --font-color: #1c1e21;
            --light-color: #ffffff;
            --shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            --danger-color: #dc3545;
            --success-color: #28a745;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--font-color);
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 15px; }

        .header { background: var(--primary-gradient); color: var(--light-color); padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 1000; }
        .navbar { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: bold; }
        .menu-toggle { font-size: 2rem; background: none; border: none; color: white; cursor: pointer; }
        
        .side-nav { position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background: var(--light-color); box-shadow: var(--shadow); transition: left 0.3s ease-in-out; z-index: 1001; padding-top: 60px; }
        .side-nav.active { left: 0; }
        .side-nav ul { list-style: none; }
        .side-nav ul li a { display: flex; align-items: center; gap: 15px; padding: 15px 25px; text-decoration: none; color: var(--font-color); font-size: 1.1rem; border-bottom: 1px solid #eee; }
        .side-nav ul li a:hover { background-color: #f0f2f5; }
        .close-nav { position: absolute; top: 15px; right: 25px; font-size: 2rem; color: #555; cursor: pointer; }

        main { padding: 2rem 0; }

        .search-container { background: var(--light-color); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 2rem; }
        #search-form { display: flex; flex-direction: column; gap: 15px; }
        #multi-prompt-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            font-size: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            background-color: #f0f2f5;
        }
        #multi-prompt-textarea:focus { outline: none; border-color: #6a11cb; }
        
        .form-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .search-button { flex: 1 1 auto; padding: 12px 20px; font-size: 1rem; background-image: var(--primary-gradient); color: white; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
        .clear-button { flex: 1 1 auto; padding: 12px 20px; font-size: 1rem; background-color: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 15px; }
        .filters select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; background-color: #f0f2f5; }
        .filters select:disabled { background-color: #e9ecef; opacity: 0.7; }
        .filters .ai-filter, .filters .search-filter { display: none; } /* Hide by default */

        #home-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 50vh; text-align: center; color: #888; }
        #home-placeholder svg { width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.5; }
        #home-placeholder h2 { font-size: 1.5rem; }

        #results-container { display: flex; flex-direction: column; gap: 30px; }
        .result-box { background-color: var(--light-color); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); position: relative; }
        .result-box-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .result-box-title { font-size: 1.5rem; color: var(--font-color); flex-grow: 1; margin: 0; }
        .result-box-header button { padding: 8px 12px; font-size: 0.9rem; border: none; border-radius: 20px; color: white; cursor: pointer; }
        .select-all-btn { background-color: #007aff; }
        .download-zip-btn { background-color: var(--success-color); }
        .close-box-btn { position: absolute; top: 15px; right: 15px; background-color: var(--danger-color); color: white; border-radius: 50%; width: 30px; height: 30px; font-weight: bold; padding: 0; line-height: 30px; text-align: center; }
        
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .image-card { background-color: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; position: relative; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .image-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .image-card img { width: 100%; height: 250px; object-fit: cover; display: block; }
        .select-checkbox { position: absolute; top: 10px; right: 10px; width: 25px; height: 25px; cursor: pointer; z-index: 10; accent-color: var(--primary-gradient); }
        
        .message { text-align: center; font-size: 1.2rem; color: #666; padding: 2rem 0; }
        .footer { text-align: center; padding: 1rem 0; background: var(--primary-gradient); color: white; }
        
        @media (max-width: 768px) { body { padding-top: 65px; padding-bottom: 50px; } .header { position: fixed; top: 0; width: 100%; } .footer { position: fixed; bottom: 0; width: 100%; padding: 15px 0; } main { padding: 1rem 0; } }
        #image-preview-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 10px; overflow-y: auto; } #image-preview-overlay.show { display: flex; } .preview-content { background: white; border-radius: 12px; padding: 15px; max-width: 95vw; max-height: 95vh; display: flex; flex-direction: column; } #preview-close-btn { align-self: flex-end; font-size: 2rem; color: #555; cursor: pointer; line-height: 1; } #preview-img { max-width: 100%; max-height: 50vh; object-fit: contain; margin-bottom: 15px; } #preview-info { font-size: 0.9rem; color: #555; margin-bottom: 15px; text-align: center; } .preview-actions { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; } .preview-actions .action-btn { padding: 10px 20px; border: none; border-radius: 25px; font-size: 1rem; cursor: pointer; color: white; text-decoration: none; } #preview-download-btn { background-color: #007aff; } #preview-share-btn { background-color: #34c759; } .related-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; border-top: 1px solid #eee; padding-top: 15px; text-align: center; } #related-images-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-height: 150px; overflow-y: auto; } #related-images-container img { width: 100%; height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2001; display: none; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 20px 0; } .modal-overlay.active { display: flex; } .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: var(--shadow); margin-top: 20px; margin-bottom: 20px; } .modal-content h2 { margin-bottom: 20px; } .modal-section { border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 20px; } .modal-section h3 { margin-top: 0; margin-bottom: 15px; } .input-group { margin-bottom: 15px; } .modal-content label { display: block; margin-bottom: 5px; font-weight: bold; } .modal-content input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; } .modal-actions { display: flex; gap: 10px; } .modal-content button { width: 100%; padding: 12px; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; } .save-btn { background-color: #007aff; } .remove-btn { background-color: var(--danger-color); } .status-text { font-size: 0.8rem; color: var(--success-color); margin-top: 5px; height: 1em; }
    </style>
</head>
<body>

    <header class="header"><div class="container navbar"><div class="logo">Ran Image Generator</div><button class="menu-toggle" id="menu-toggle">‚ò∞</button></div></header>
    <nav class="side-nav" id="side-nav"><div class="close-nav" id="close-nav">&times;</div><ul><li><a href="#">üè† ‡§π‡•ã‡§Æ</a></li><li><a href="#">üíæ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°‡•ç‡§∏ (‡§ú‡§≤‡•ç‡§¶ ‡§Ü ‡§∞‡§π‡§æ ‡§π‡•à)</a></li><li><a href="#">üìú ‡§π‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä (‡§ú‡§≤‡•ç‡§¶ ‡§Ü ‡§∞‡§π‡§æ ‡§π‡•à)</a></li><li><a href="#" id="settings-btn">‚öôÔ∏è ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ (API Keys)</a></li></ul></nav>
    <main class="container">
        <section class="search-container">
            <form id="search-form">
                <textarea id="multi-prompt-textarea" placeholder="‡§Ø‡§π‡§æ‡§Å ‡§è‡§ï ‡§Ø‡§æ ‡§Ö‡§ß‡§ø‡§ï ‡§™‡•ç‡§∞‡•â‡§Æ‡•ç‡§™‡•ç‡§ü ‡§°‡§æ‡§≤‡•á‡§Ç (‡§π‡§∞ ‡§™‡•ç‡§∞‡•â‡§Æ‡•ç‡§™‡•ç‡§ü ‡§®‡§à ‡§≤‡§æ‡§á‡§® ‡§™‡§∞)..." required></textarea>
                <div class="form-actions">
                    <button type="submit" class="search-button">‡§ñ‡•ã‡§ú‡•á‡§Ç</button>
                    <button type="button" id="clear-btn" class="clear-button">‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button>
                </div>
            </form>
            <div class="filters">
                <select id="source-select">
                    <option value="google">‡§∏‡•ç‡§∞‡•ã‡§§: Google</option>
                    <option value="pexels">‡§∏‡•ç‡§∞‡•ã‡§§: Pexels</option>
                    <option value="huggingface">‡§∏‡•ç‡§∞‡•ã‡§§: Hugging Face</option>
                    <option value="replicate">‡§∏‡•ç‡§∞‡•ã‡§§: Replicate</option>
                </select>
                <!-- Search Filters -->
                <select id="search-image-count-select" class="search-filter">
                    <option value="5">5 ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞‡•á‡§Ç</option>
                    <option value="10" selected>10 ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞‡•á‡§Ç</option>
                    <option value="15">15 ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞‡•á‡§Ç</option>
                    <option value="20">20 ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞‡•á‡§Ç</option>
                </select>
                <select id="orientation-select" class="search-filter"><option value="">‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§ì‡§∞‡§ø‡§è‡§Ç‡§ü‡•á‡§∂‡§®</option><option value="landscape">Landscape</option><option value="portrait">Portrait</option><option value="square">Square</option></select>
                <select id="google-size-select" class="search-filter"><option value="">‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§∏‡§æ‡§á‡•õ</option><option value="large">‡§¨‡•ú‡§æ</option><option value="medium">‡§Æ‡•Ä‡§°‡§ø‡§Ø‡§Æ</option><option value="small">‡§õ‡•ã‡§ü‡§æ</option><option value="icon">‡§Ü‡§á‡§ï‡§®</option></select>
                <select id="color-select" class="search-filter google-filter"><option value="">‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§∞‡§Ç‡§ó</option><option value="color">‡§∞‡§Ç‡§ó‡•Ä‡§®</option><option value="gray">‡§¨‡•ç‡§≤‡•à‡§ï & ‡§µ‡§æ‡§á‡§ü</option></select>
                <select id="type-select" class="search-filter google-filter"><option value="">‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</option><option value="photo">‡§´‡•ã‡§ü‡•ã</option><option value="clipart">‡§ï‡•ç‡§≤‡§ø‡§™‡§Ü‡§∞‡•ç‡§ü</option><option value="lineart">‡§≤‡§æ‡§á‡§® ‡§Ü‡§∞‡•ç‡§ü</option></select>
                <!-- AI Generation Filters -->
                <select id="ai-generate-count-select" class="ai-filter">
                    <option value="1">1 ‡§á‡§Æ‡•á‡§ú ‡§¨‡§®‡§æ‡§è‡§Ç</option>
                    <option value="2">2 ‡§á‡§Æ‡•á‡§ú ‡§¨‡§®‡§æ‡§è‡§Ç</option>
                    <option value="3">3 ‡§á‡§Æ‡•á‡§ú ‡§¨‡§®‡§æ‡§è‡§Ç</option>
                    <option value="4">4 ‡§á‡§Æ‡•á‡§ú ‡§¨‡§®‡§æ‡§è‡§Ç</option>
                </select>
                <select id="ai-aspect-ratio-select" class="ai-filter">
                    <option value="1:1">Square (1:1)</option>
                    <option value="16:9">Landscape (16:9)</option>
                    <option value="9:16">Portrait (9:16)</option>
                </select>
            </div>
        </section>

        <div id="home-placeholder"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.92,7.62A1,1,0,0,0,21,7H3a1,1,0,0,0-.92.62,1,1,0,0,0,.21,1.09l5.45,5.45A1,1,0,0,1,8,15.59V19a1,1,0,0,0,1,1H15a1,1,0,0,0,1-1V15.59a1,1,0,0,1,.29-.71l5.45-5.45A1,1,0,0,0,21.92,7.62ZM15.29,14.88a3,3,0,0,0-.87,2.12V18H9.58V17a3,3,0,0,0-.87-2.12L4.41,10H19.59ZM12,6a3,3,0,1,0-3-3A3,3,0,0,0,12,6Z"/></svg><h2>Ran Image Generator</h2><p>‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§ñ‡•ã‡§ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ä‡§™‡§∞ ‡§∏‡§∞‡•ç‡§ö ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Ü‡§™ ‡§è‡§ï ‡§∏‡•á ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§™‡•ç‡§∞‡•â‡§Æ‡•ç‡§™‡•ç‡§ü ‡§≠‡•Ä ‡§ú‡•ã‡§°‡§º ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§</p></div>
        
        <section id="results-container"></section>
        <div id="message" class="message"></div>
    </main>
    <footer class="footer"><p>&copy; 2023 Ran Image Generator</p></footer>
    
    <div class="modal-overlay" id="api-modal">
        <div class="modal-content">
            <h2>API Key ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</h2>
            <div class="modal-section">
                <h3>Replicate Settings</h3>
                <div class="input-group">
                    <label for="replicate-key">Replicate API Token</label>
                    <input type="password" id="replicate-key" placeholder="Replicate ‡§ï‡§æ Token ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç">
                </div>
                <div class="modal-actions">
                    <button id="save-replicate-btn" class="save-btn">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
                    <button id="remove-replicate-btn" class="remove-btn">Remove Token</button>
                </div>
                <p id="replicate-status" class="status-text"></p>
            </div>
            <div class="modal-section">
                <h3>Hugging Face Settings</h3>
                <div class="input-group">
                    <label for="huggingface-key">Hugging Face API Token</label>
                    <input type="password" id="huggingface-key" placeholder="Hugging Face ‡§ï‡§æ Token ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç">
                </div>
                <div class="modal-actions">
                    <button id="save-huggingface-btn" class="save-btn">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
                    <button id="remove-huggingface-btn" class="remove-btn">Remove Token</button>
                </div>
                <p id="huggingface-status" class="status-text"></p>
            </div>
            <div class="modal-section">
                <h3>Pexels Settings</h3>
                <div class="input-group">
                    <label for="pexels-key">Pexels API Key</label>
                    <input type="password" id="pexels-key" placeholder="Pexels ‡§ï‡•Ä Key ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç">
                </div>
                <div class="modal-actions">
                    <button id="save-pexels-btn" class="save-btn">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
                    <button id="remove-pexels-btn" class="remove-btn">Remove Key</button>
                </div>
                <p id="pexels-status" class="status-text"></p>
            </div>
            <div class="modal-section">
                <h3>Google Settings</h3>
                <div class="input-group">
                    <label for="google-key">Google API Key</label>
                    <input type="password" id="google-key" placeholder="Google API Key ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç">
                </div>
                <div class="input-group">
                    <label for="google-cx">Google Search Engine ID (CX)</label>
                    <input type="password" id="google-cx" placeholder="Google CX ID ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç">
                </div>
                <div class="modal-actions">
                    <button id="save-google-btn" class="save-btn">‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
                    <button id="remove-google-btn" class="remove-btn">Remove Keys</button>
                </div>
                <p id="google-status" class="status-text"></p>
            </div>
        </div>
    </div>
    <div id="image-preview-overlay"><div class="preview-content"><span id="preview-close-btn">&times;</span><img id="preview-img" src="" alt="Image Preview"><p id="preview-info"></p><div class="preview-actions"><a id="preview-download-btn" class="action-btn" href="#" target="_blank">‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</a><button id="preview-share-btn" class="action-btn">‡§∂‡•á‡§Ø‡§∞</button></div><h3 class="related-title">‡§Æ‡§ø‡§≤‡§§‡•Ä-‡§ú‡•Å‡§≤‡§§‡•Ä ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞‡•á‡§Ç</h3><div id="related-images-container"></div></div></div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').then(reg => console.log('SW registered.')).catch(err => console.log('SW registration failed:', err));
        });
    }

    // --- DOM Elements ---
    const form = document.getElementById('search-form');
    const promptTextarea = document.getElementById('multi-prompt-textarea');
    const clearBtn = document.getElementById('clear-btn');
    const resultsContainer = document.getElementById('results-container');
    const messageDiv = document.getElementById('message');
    const sourceSelect = document.getElementById('source-select');
    const homePlaceholder = document.getElementById('home-placeholder');
    
    // Filter Elements
    const searchImageCountSelect = document.getElementById('search-image-count-select');
    const orientationSelect = document.getElementById('orientation-select');
    const googleSizeSelect = document.getElementById('google-size-select');
    const colorSelect = document.getElementById('color-select');
    const typeSelect = document.getElementById('type-select');
    const aiGenerateCountSelect = document.getElementById('ai-generate-count-select');
    const aiAspectRatioSelect = document.getElementById('ai-aspect-ratio-select');

    // Sidebar and Modal Elements
    const menuToggle = document.getElementById('menu-toggle');
    const sideNav = document.getElementById('side-nav');
    const closeNav = document.getElementById('close-nav');
    const settingsBtn = document.getElementById('settings-btn');
    const apiModal = document.getElementById('api-modal');
    
    // API Modal Input/Button Elements
    const savePexelsBtn = document.getElementById('save-pexels-btn');
    const removePexelsBtn = document.getElementById('remove-pexels-btn');
    const pexelsKeyInput = document.getElementById('pexels-key');
    const pexelsStatus = document.getElementById('pexels-status');

    const saveGoogleBtn = document.getElementById('save-google-btn');
    const removeGoogleBtn = document.getElementById('remove-google-btn');
    const googleKeyInput = document.getElementById('google-key');
    const googleCxInput = document.getElementById('google-cx');
    const googleStatus = document.getElementById('google-status');
    
    const saveHuggingFaceBtn = document.getElementById('save-huggingface-btn');
    const removeHuggingFaceBtn = document.getElementById('remove-huggingface-btn');
    const huggingFaceKeyInput = document.getElementById('huggingface-key');
    const huggingFaceStatus = document.getElementById('huggingface-status');

    const saveReplicateBtn = document.getElementById('save-replicate-btn');
    const removeReplicateBtn = document.getElementById('remove-replicate-btn');
    const replicateKeyInput = document.getElementById('replicate-key');
    const replicateStatus = document.getElementById('replicate-status');

    // Preview Modal Elements
    const previewOverlay = document.getElementById('image-preview-overlay');
    const previewImg = document.getElementById('preview-img');
    const previewInfo = document.getElementById('preview-info');
    const previewDownloadBtn = document.getElementById('preview-download-btn');
    const previewShareBtn = document.getElementById('preview-share-btn');
    const previewCloseBtn = document.getElementById('preview-close-btn');
    const relatedImagesContainer = document.getElementById('related-images-container');

    // App State
    let apiKeys = { pexels: '', google: '', googleCx: '', huggingface: '', replicate: '' };
    let allImagesData = [];

    // --- UI Navigation ---
    menuToggle.addEventListener('click', () => sideNav.classList.add('active'));
    closeNav.addEventListener('click', () => sideNav.classList.remove('active'));
    settingsBtn.addEventListener('click', (e) => {
        e.preventDefault();
        apiModal.classList.add('active');
        sideNav.classList.remove('active');
    });
    apiModal.addEventListener('click', (e) => {
        if (e.target === apiModal) apiModal.classList.remove('active');
    });

    clearBtn.addEventListener('click', () => {
        resultsContainer.innerHTML = '';
        messageDiv.textContent = '';
        promptTextarea.value = '';
        homePlaceholder.style.display = 'flex';
        allImagesData = [];
    });

    sourceSelect.addEventListener('change', () => {
        const source = sourceSelect.value;
        const isGoogle = source === 'google';
        const isPexels = source === 'pexels';
        const isAI = source === 'huggingface' || source === 'replicate';

        document.querySelectorAll('.search-filter').forEach(el => el.style.display = (isGoogle || isPexels) ? 'block' : 'none');
        document.querySelectorAll('.ai-filter').forEach(el => el.style.display = isAI ? 'block' : 'none');
        
        document.querySelectorAll('.google-filter').forEach(f => f.style.display = isGoogle ? 'block' : 'none');
        orientationSelect.style.display = isPexels ? 'block' : 'none';
    });
    
    // --- API Key Management ---
    function loadApiKeys() {
        apiKeys.pexels = localStorage.getItem('pexelsApiKey') || '';
        apiKeys.google = localStorage.getItem('googleApiKey') || '';
        apiKeys.googleCx = localStorage.getItem('googleCxId') || '';
        apiKeys.huggingface = localStorage.getItem('huggingfaceApiKey') || '';
        apiKeys.replicate = localStorage.getItem('replicateApiKey') || '';

        pexelsKeyInput.value = apiKeys.pexels;
        googleKeyInput.value = apiKeys.google;
        googleCxInput.value = apiKeys.googleCx;
        huggingFaceKeyInput.value = apiKeys.huggingface;
        replicateKeyInput.value = apiKeys.replicate;

        updateSourceOptions();
        const anyKeyReady = apiKeys.pexels || (apiKeys.google && apiKeys.googleCx) || apiKeys.huggingface || apiKeys.replicate;
        if (!anyKeyReady) {
            setTimeout(() => apiModal.classList.add('active'), 500);
        }
    }
    
    function updateSourceOptions() {
        const pexelsOption = sourceSelect.querySelector('option[value="pexels"]');
        const googleOption = sourceSelect.querySelector('option[value="google"]');
        const huggingfaceOption = sourceSelect.querySelector('option[value="huggingface"]');
        const replicateOption = sourceSelect.querySelector('option[value="replicate"]');

        pexelsOption.disabled = !apiKeys.pexels;
        googleOption.disabled = !apiKeys.google || !apiKeys.googleCx;
        huggingfaceOption.disabled = !apiKeys.huggingface;
        replicateOption.disabled = !apiKeys.replicate;

        if (sourceSelect.options[sourceSelect.selectedIndex].disabled) {
             const firstEnabledOption = Array.from(sourceSelect.options).find(opt => !opt.disabled);
             if (firstEnabledOption) {
                sourceSelect.value = firstEnabledOption.value;
             }
        }
        sourceSelect.dispatchEvent(new Event('change'));
    }

    // Pexels Listeners
    savePexelsBtn.addEventListener('click', () => {const key = pexelsKeyInput.value.trim();if (key) {localStorage.setItem('pexelsApiKey', key);apiKeys.pexels = key;pexelsStatus.textContent = 'Pexels Key Saved!';setTimeout(() => { pexelsStatus.textContent = ''; apiModal.classList.remove('active'); }, 2000);updateSourceOptions();} else { alert('‡§ï‡•É‡§™‡§Ø‡§æ Pexels API Key ‡§°‡§æ‡§≤‡•á‡§Ç‡•§'); }});
    removePexelsBtn.addEventListener('click', () => {localStorage.removeItem('pexelsApiKey');apiKeys.pexels = '';pexelsKeyInput.value = '';pexelsStatus.textContent = 'Pexels Key Removed!';setTimeout(() => pexelsStatus.textContent = '', 2000);updateSourceOptions();});
    
    // Google Listeners
    saveGoogleBtn.addEventListener('click', () => {const apiKey = googleKeyInput.value.trim();const cxId = googleCxInput.value.trim();if (apiKey && cxId) {localStorage.setItem('googleApiKey', apiKey);localStorage.setItem('googleCxId', cxId);apiKeys.google = apiKey;apiKeys.googleCx = cxId;googleStatus.textContent = 'Google Keys Saved!';setTimeout(() => { googleStatus.textContent = ''; apiModal.classList.remove('active'); }, 2000);updateSourceOptions();} else { alert('‡§ï‡•É‡§™‡§Ø‡§æ Google ‡§ï‡•Ä ‡§¶‡•ã‡§®‡•ã‡§Ç Keys ‡§°‡§æ‡§≤‡•á‡§Ç‡•§'); }});
    removeGoogleBtn.addEventListener('click', () => {localStorage.removeItem('googleApiKey');localStorage.removeItem('googleCxId');apiKeys.google = '';apiKeys.googleCx = '';googleKeyInput.value = '';googleCxInput.value = '';googleStatus.textContent = 'Google Keys Removed!';setTimeout(() => googleStatus.textContent = '', 2000);updateSourceOptions();});

    // Hugging Face Listeners
    saveHuggingFaceBtn.addEventListener('click', () => { const key = huggingFaceKeyInput.value.trim(); if (key) { localStorage.setItem('huggingfaceApiKey', key); apiKeys.huggingface = key; huggingFaceStatus.textContent = 'Hugging Face Token Saved!'; setTimeout(() => { huggingFaceStatus.textContent = ''; apiModal.classList.remove('active'); }, 2000); updateSourceOptions(); } else { alert('‡§ï‡•É‡§™‡§Ø‡§æ Hugging Face API Token ‡§°‡§æ‡§≤‡•á‡§Ç‡•§'); } });
    removeHuggingFaceBtn.addEventListener('click', () => { localStorage.removeItem('huggingfaceApiKey'); apiKeys.huggingface = ''; huggingFaceKeyInput.value = ''; huggingFaceStatus.textContent = 'Hugging Face Token Removed!'; setTimeout(() => huggingFaceStatus.textContent = '', 2000); updateSourceOptions(); });
    
    // Replicate Listeners
    saveReplicateBtn.addEventListener('click', () => { const key = replicateKeyInput.value.trim(); if (key) { localStorage.setItem('replicateApiKey', key); apiKeys.replicate = key; replicateStatus.textContent = 'Replicate Token Saved!'; setTimeout(() => { replicateStatus.textContent = ''; apiModal.classList.remove('active'); }, 2000); updateSourceOptions(); } else { alert('‡§ï‡•É‡§™‡§Ø‡§æ Replicate API Token ‡§°‡§æ‡§≤‡•á‡§Ç‡•§'); } });
    removeReplicateBtn.addEventListener('click', () => { localStorage.removeItem('replicateApiKey'); apiKeys.replicate = ''; replicateKeyInput.value = ''; replicateStatus.textContent = 'Replicate Token Removed!'; setTimeout(() => replicateStatus.textContent = '', 2000); updateSourceOptions(); });

    // --- Search and Display Logic ---
    form.addEventListener('submit', async (e) => { 
        e.preventDefault();
        const prompts = promptTextarea.value.trim().split('\n').map(p => p.trim()).filter(p => p.length > 0);
        if (prompts.length > 0) {
            resultsContainer.innerHTML = '';
            messageDiv.textContent = '';
            homePlaceholder.style.display = 'none';
            allImagesData = [];

            for (const query of prompts) {
                const resultBox = createResultBox(query);
                const imageGrid = resultBox.querySelector('.image-grid');
                const resultMessage = resultBox.querySelector('.result-message');
                
                const source = sourceSelect.value;
                const isAI = source === 'huggingface' || source === 'replicate';
                const count = isAI ? parseInt(aiGenerateCountSelect.value, 10) : parseInt(searchImageCountSelect.value, 10);
                
                if (isAI) {
                    const generationPromises = [];
                    for (let i = 0; i < count; i++) {
                        generationPromises.push(fetchAndDisplay(query, imageGrid, resultMessage));
                    }
                    await Promise.all(generationPromises);
                } else {
                    await fetchAndDisplay(query, imageGrid, resultMessage);
                }
            }
        } else {
            showMessage("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ñ‡•ã‡§ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§™‡•ç‡§∞‡•â‡§Æ‡•ç‡§™‡•ç‡§ü ‡§°‡§æ‡§≤‡•á‡§Ç‡•§");
        }
    });
    
    function createResultBox(query) {
        const resultBox = document.createElement('div');
        resultBox.className = 'result-box';
        resultBox.dataset.prompt = query;
        resultBox.innerHTML = `
            <button class="close-box-btn" title="‡§á‡§∏ ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ï‡•ã ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç">X</button>
            <div class="result-box-header">
                <h3 class="result-box-title">"${query}"</h3>
                <button class="select-all-btn">‡§∏‡§≠‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç</button>
                <button class="download-zip-btn">‡§ö‡•Å‡§®‡•Ä ‡§π‡•Å‡§à Zip ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
            <div class="image-grid"></div>
            <p class="message result-message"></p>
        `;
        resultsContainer.appendChild(resultBox);
        resultBox.querySelector('.close-box-btn').addEventListener('click', () => resultBox.remove());
        resultBox.querySelector('.select-all-btn').addEventListener('click', (e) => toggleSelectAll(resultBox, e.target));
        resultBox.querySelector('.download-zip-btn').addEventListener('click', (e) => downloadBoxAsZip(resultBox, e.target));
        return resultBox;
    }
    
    const delay = ms => new Promise(res => setTimeout(res, ms));

    async function fetchAndDisplay(query, targetGrid, targetMessage) {
        const source = sourceSelect.value;
        let items = [];
        let errorMsg = null;
        
        const isAI = source === 'huggingface' || source === 'replicate';
        targetMessage.textContent = isAI ? "‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§¨‡§®‡§æ‡§à ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à (‡§á‡§∏‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§Ø ‡§≤‡§ó ‡§∏‡§ï‡§§‡§æ ‡§π‡•à)..." : "‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞‡•á‡§Ç ‡§ñ‡•ã‡§ú‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à‡§Ç...";

        try {
            if (source === 'pexels' && apiKeys.pexels) {
                const count = searchImageCountSelect.value;
                const orientation = orientationSelect.value;
                let url = `https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&page=1&per_page=${count}`;
                if (orientation) url += `&orientation=${orientation}`;
                const response = await fetch(url, { headers: { Authorization: apiKeys.pexels } });
                if (!response.ok) throw new Error(`Pexels API Error: ${response.statusText}`);
                const data = await response.json();
                items = data.photos;
            } else if (source === 'google' && apiKeys.google) {
                const count = Math.min(searchImageCountSelect.value, 10);
                let url = `https://www.googleapis.com/customsearch/v1?key=${apiKeys.google}&cx=${apiKeys.googleCx}&q=${encodeURIComponent(query)}&searchType=image&start=1&num=${count}`;
                if (colorSelect.value) url += `&imgColorType=${colorSelect.value}`;
                if (typeSelect.value) url += `&imgType=${typeSelect.value}`;
                if (googleSizeSelect.value) url += `&imgSize=${googleSizeSelect.value}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Google API Error: ${response.statusText}`);
                const data = await response.json();
                items = data.items;
            } else if (source === 'huggingface' && apiKeys.huggingface) {
                const MODEL_ID = "stabilityai/stable-diffusion-xl-base-1.0";
                const aspectRatio = aiAspectRatioSelect.value;
                const promptWithRatio = `${query}, ${aspectRatio} aspect ratio, high quality`;
                
                const response = await fetch(`https://api-inference.huggingface.co/models/${MODEL_ID}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKeys.huggingface}` },
                    body: JSON.stringify({ inputs: promptWithRatio })
                });
                if (!response.ok) throw new Error(`Hugging Face API Error: ${response.statusText} - ${await response.text()}`);
                const blob = await response.blob();
                const objectURL = URL.createObjectURL(blob);
                items = [{ generated: true, imgSrc: objectURL, altText: query, downloadUrl: objectURL, author: `Hugging Face (${MODEL_ID})` }];
            } else if (source === 'replicate' && apiKeys.replicate) {
                // FIX: Use a CORS proxy to bypass browser security restrictions
                const proxyUrl = 'https://corsproxy.io/?';
                const replicateApiUrl = 'https://api.replicate.com/v1/predictions';
                
                const [width, height] = aiAspectRatioSelect.value === '16:9' ? [1344, 768] : aiAspectRatioSelect.value === '9:16' ? [768, 1344] : [1024, 1024];
                const startResponse = await fetch(proxyUrl + replicateApiUrl, {
                    method: "POST",
                    headers: { Authorization: `Token ${apiKeys.replicate}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        version: "39ed52f2a78e934b3ba6e2a89f5b1c712de7dfea535525255b1aa35c5565e08b", // SDXL version
                        input: { prompt: query, width, height },
                    }),
                });
                let prediction = await startResponse.json();
                if (startResponse.status !== 201) throw new Error(`Replicate API Error: ${prediction.detail}`);
                
                while (prediction.status !== "succeeded" && prediction.status !== "failed") {
                    await delay(2000);
                    // FIX: Use proxy for polling requests as well
                    const pollResponse = await fetch(proxyUrl + prediction.urls.get, { headers: { Authorization: `Token ${apiKeys.replicate}` } });
                    prediction = await pollResponse.json();
                    if (pollResponse.status !== 200) throw new Error(`Replicate polling failed: ${prediction.detail}`);
                }
                
                if (prediction.status === "succeeded" && prediction.output && prediction.output.length > 0) {
                    const imageUrl = prediction.output[0];
                    items = [{ generated: true, imgSrc: imageUrl, altText: query, downloadUrl: imageUrl, author: 'Replicate (SDXL)' }];
                } else {
                    throw new Error("Replicate generation failed or returned no output.");
                }
            } else {
                errorMsg = "‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§ï‡§∞ ‡§á‡§∏ ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§ï‡•á ‡§≤‡§ø‡§è API Keys ‡§°‡§æ‡§≤‡•á‡§Ç‡•§";
            }
        } catch (error) {
            console.error(error);
            errorMsg = `${source} ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•Å‡§à: ${error.message}`;
        }

        if (items.length > 0 || !errorMsg) {
             targetMessage.textContent = ''; // Clear message on success or if there's no error for this specific call
        }
        
        if (errorMsg) {
            targetMessage.textContent = errorMsg;
            return;
        }

        if (!items || items.length === 0) {
            if (!targetGrid.hasChildNodes()) { // Only show 'no results' if the grid is empty
               targetMessage.textContent = `'${query}' ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§`;
            }
            return;
        }
        displayImages(items, source, targetGrid);
    }

    function displayImages(items, source, targetGrid) {
        items.forEach(item => {
            const data = {};
            if (item.generated) {
                data.imgSrc = item.imgSrc;
                data.author = item.author;
                data.downloadUrl = item.downloadUrl;
                data.downloadAttr = 'download';
                data.altText = item.altText;
            } else if (source === 'pexels') {
                data.imgSrc = item.src.large;
                data.author = `By: ${item.photographer}`;
                data.downloadUrl = item.src.original;
                data.downloadAttr = 'download';
                data.altText = item.alt;
            } else { // Google case
                if (!item.link) return;
                data.imgSrc = item.link;
                data.author = item.displayLink;
                data.downloadUrl = item.link;
                data.downloadAttr = '';
                data.altText = item.title;
            }

            const currentId = allImagesData.length;
            data.id = currentId;
            allImagesData.push(data);

            const card = document.createElement('div');
            card.className = 'image-card';
            card.dataset.id = currentId;
            card.dataset.downloadUrl = data.downloadUrl;
            card.innerHTML = `
                <input type="checkbox" class="select-checkbox" title="‡§á‡§∏ ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§ï‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç">
                <img src="${data.imgSrc}" alt="${data.altText}" loading="lazy" onerror="this.parentElement.style.display='none'">
            `;
            card.querySelector('img').addEventListener('click', () => openPreview(currentId));
            card.querySelector('.select-checkbox').addEventListener('click', (e) => e.stopPropagation());
            targetGrid.appendChild(card);
        });
    }

    function showMessage(msg) {
        resultsContainer.innerHTML = '';
        messageDiv.textContent = msg;
        homePlaceholder.style.display = 'none';
    }

    function toggleSelectAll(resultBox, btn) {
        const checkboxes = resultBox.querySelectorAll('.select-checkbox');
        const isCurrentlyAllSelected = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => { cb.checked = !isCurrentlyAllSelected; });
        btn.textContent = isCurrentlyAllSelected ? '‡§∏‡§≠‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç' : '‡§∏‡§≠‡•Ä ‡§π‡§ü‡§æ‡§è‡§Ç';
    }
    
    async function downloadBoxAsZip(resultBox, btn) {
        const promptText = resultBox.dataset.prompt;
        const filename = promptText.replace(/\s+/g, '_').replace(/[^\p{L}\p{N}_-]/gu, '') + '.zip';
        const checkedBoxes = resultBox.querySelectorAll('.select-checkbox:checked');
        if (checkedBoxes.length === 0) { alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§á‡§∏ ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§'); return; }
        const btnOriginalText = btn.textContent;
        btn.textContent = '‡§ú‡§º‡§ø‡§™‡§ø‡§Ç‡§ó... (0%)';
        btn.disabled = true;
        const zip = new JSZip();
        let downloadedCount = 0;
        const fetchPromises = Array.from(checkedBoxes).map(async (box, index) => {
            const card = box.closest('.image-card');
            const url = card.dataset.downloadUrl;
            let imgFilename = `image-${index + 1}`;
            const extension = url.startsWith('blob:') ? '.png' : (url.split('?')[0].split('.').pop() || 'jpg');
            if (extension.length < 5) { imgFilename += '.' + extension; }

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Fetch failed`);
                const blob = await response.blob();
                zip.file(imgFilename, blob);
                downloadedCount++;
                btn.textContent = `‡§ú‡§º‡§ø‡§™‡§ø‡§Ç‡§ó... (${Math.round((downloadedCount / checkedBoxes.length) * 100)}%)`;
            } catch (error) { console.error(`Download failed for ${url}:`, error); zip.file(`failed_download_${index+1}.txt`, `Could not download from URL: ${url}`); }
        });
        await Promise.all(fetchPromises);
        zip.generateAsync({ type: "blob" }).then(function(content) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            btn.textContent = btnOriginalText;
            btn.disabled = false;
        });
    }

    // --- Preview Modal Functions ---
    function openPreview(id) {const data = allImagesData[id];if (!data) return;previewImg.src = data.imgSrc;previewInfo.textContent = `Source: ${data.author}`;previewDownloadBtn.href = data.downloadUrl;data.downloadAttr === 'download' ? previewDownloadBtn.setAttribute('download', `image_${id}.png`) : previewDownloadBtn.removeAttribute('download');previewShareBtn.onclick = () => shareImage(data.downloadUrl, data.altText);previewOverlay.classList.add('show');loadRelatedImages();}
    function closePreview() { previewOverlay.classList.remove('show'); }
    function loadRelatedImages() {relatedImagesContainer.innerHTML = '';const shuffled = [...allImagesData].sort(() => 0.5 - Math.random()).slice(0, 6);shuffled.forEach(data => {const img = document.createElement('img');img.src = data.imgSrc;img.addEventListener('click', () => openPreview(data.id));relatedImagesContainer.appendChild(img);});}
    async function shareImage(url, text) {
        try {
            const response = await fetch(url);
            const blob = await response.blob();
            const file = new File([blob], "image.png", { type: blob.type });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({ files: [file], title: 'Check out this image!', text: text });
            } else if (navigator.share) {
                await navigator.share({ title: 'Check out this image!', text: text, url: url });
            } else { throw new Error('Web Share API not supported.'); }
        } catch (error) {
            console.error('Share failed:', error);
            navigator.clipboard.writeText(url).then(() => { alert('Image link copied to clipboard!'); });
        }
    }
    previewCloseBtn.addEventListener('click', closePreview);previewOverlay.addEventListener('click', (e) => { if (e.target === previewOverlay) closePreview(); });

    // --- Initial Load ---
    loadApiKeys();
});
</script>
</body>
</html>
